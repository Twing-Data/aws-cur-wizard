# Metrics view YAML
# Reference documentation: https://docs.rilldata.com/reference/project-files/metrics-views
# AWS Cost and Usage Report (CUR) Metrics Dashboard

version: 1
type: metrics_view

display_name: AWS Cost Analysis
model: cur
timeseries: line_item_usage_start_date

dimensions:
  # Primary cost breakdown dimensions
  - name: service
    display_name: Service
    column: line_item_product_code
    description: AWS service (e.g., AmazonEC2, AmazonS3)

  - name: account_id
    display_name: Account ID
    column: line_item_usage_account_id
    description: AWS account ID incurring the cost

  - name: account_name
    display_name: Account Name
    column: line_item_usage_account_name
    description: AWS account name

  - name: region
    display_name: Region
    column: product_region_code
    description: AWS region (e.g., us-east-1, eu-west-1)

  - name: availability_zone
    display_name: Availability Zone
    column: line_item_availability_zone
    description: Specific AZ within region

  # Charge type dimensions
  - name: charge_type
    display_name: Charge Type
    column: line_item_line_item_type
    description: Type of charge (Usage, Tax, Fee, etc.)

  - name: pricing_term
    display_name: Pricing Term
    column: pricing_term
    description: On-Demand, Reserved, or Spot

  - name: purchase_option
    display_name: Purchase Option
    column: pricing_purchase_option
    description: No Upfront, Partial Upfront, All Upfront

  # Resource details
  - name: usage_type
    display_name: Usage Type
    column: line_item_usage_type
    description: Specific usage type (e.g., BoxUsage, DataTransfer)

  - name: operation
    display_name: Operation
    column: line_item_operation
    description: Specific operation performed

  - name: product_family
    display_name: Product Family
    column: product_product_family
    description: Product category (Compute, Storage, etc.)

  - name: instance_type
    display_name: Instance Type
    column: product_instance_type
    description: EC2 instance type (e.g., t3.medium, m5.large)

  - name: instance_family
    display_name: Instance Family
    column: product_instance_family
    description: Instance family grouping

  # Billing dimensions
  - name: payer_account_id
    display_name: Payer Account ID
    column: bill_payer_account_id
    description: Management/payer account ID

  - name: payer_account_name
    display_name: Payer Account Name
    column: bill_payer_account_name
    description: Management/payer account name

  - name: invoice_id
    display_name: Invoice ID
    column: bill_invoice_id
    description: AWS invoice identifier

  - name: bill_type
    display_name: Bill Type
    column: bill_bill_type
    description: Anniversary or Purchase

  # Location details
  - name: location
    display_name: Location
    column: product_location
    description: Geographic location name

  # Savings and reservations
  - name: savings_plan_offering_type
    display_name: Savings Plan Type
    column: savings_plan_offering_type
    description: Compute, EC2 Instance, or SageMaker

  - name: reservation_arn
    display_name: Reservation ARN
    column: reservation_reservation_a_r_n
    description: Reserved Instance ARN

  - name: savings_plan_arn
    display_name: Savings Plan ARN
    column: savings_plan_savings_plan_a_r_n
    description: Savings Plan ARN

  # Tax
  - name: tax_type
    display_name: Tax Type
    column: line_item_tax_type
    description: Type of tax applied

  - name: legal_entity
    display_name: Legal Entity
    column: line_item_legal_entity
    description: AWS legal entity

  # Description for drill-down
  - name: description
    display_name: Line Item Description
    column: line_item_line_item_description
    description: Detailed description of the charge

measures:
  # Primary cost measures
  - name: total_cost
    display_name: Total Cost
    expression: SUM(line_item_unblended_cost)
    description: Total unblended cost - the actual cost for each account
    format_preset: currency_usd
    valid_percent_of_total: true

  - name: blended_cost
    display_name: Blended Cost
    expression: SUM(line_item_blended_cost)
    description: Blended cost averaged across all linked accounts
    format_preset: currency_usd
    valid_percent_of_total: true

  - name: net_cost
    display_name: Net Cost
    expression: SUM(line_item_net_unblended_cost)
    description: Net cost after all discounts applied
    format_preset: currency_usd
    valid_percent_of_total: true

  - name: on_demand_cost
    display_name: On-Demand Cost
    expression: SUM(pricing_public_on_demand_cost)
    description: What the cost would be at on-demand rates
    format_preset: currency_usd
    valid_percent_of_total: true

  # Savings and discounts
  - name: total_discount
    display_name: Total Discount
    expression: SUM(discount_total_discount)
    description: Total discounts from EDPs, private pricing, etc.
    format_preset: currency_usd

  - name: reservation_effective_cost
    display_name: RI Effective Cost
    expression: SUM(reservation_effective_cost)
    description: Amortized cost of Reserved Instances
    format_preset: currency_usd

  - name: savings_plan_effective_cost
    display_name: Savings Plan Cost
    expression: SUM(savings_plan_savings_plan_effective_cost)
    description: Amortized cost of Savings Plans
    format_preset: currency_usd

  - name: estimated_savings
    display_name: Estimated Savings
    expression: SUM(pricing_public_on_demand_cost) - SUM(line_item_unblended_cost)
    description: Estimated savings vs on-demand pricing
    format_preset: currency_usd

  # Usage metrics
  - name: total_usage
    display_name: Total Usage
    expression: SUM(line_item_usage_amount)
    description: Total usage quantity
    format_preset: humanize

  - name: usage_hours
    display_name: Usage Hours
    expression: SUM(CASE WHEN line_item_usage_type LIKE '%BoxUsage%' OR line_item_usage_type LIKE '%Hours%' THEN line_item_usage_amount ELSE 0 END)
    description: Compute hours consumed
    format_preset: humanize

  # Cost breakdown by charge type
  - name: usage_cost
    display_name: Usage Cost
    expression: SUM(CASE WHEN line_item_line_item_type = 'Usage' THEN line_item_unblended_cost ELSE 0 END)
    description: Cost for actual usage charges
    format_preset: currency_usd
    valid_percent_of_total: true

  - name: tax_cost
    display_name: Tax
    expression: SUM(CASE WHEN line_item_line_item_type = 'Tax' THEN line_item_unblended_cost ELSE 0 END)
    description: Tax charges
    format_preset: currency_usd
    valid_percent_of_total: true

  - name: fee_cost
    display_name: Fees
    expression: SUM(CASE WHEN line_item_line_item_type IN ('Fee', 'RIFee') THEN line_item_unblended_cost ELSE 0 END)
    description: Fees and RI fees
    format_preset: currency_usd
    valid_percent_of_total: true

  - name: credit_cost
    display_name: Credits
    expression: SUM(CASE WHEN line_item_line_item_type = 'Credit' THEN line_item_unblended_cost ELSE 0 END)
    description: Credits applied
    format_preset: currency_usd

  - name: refund_cost
    display_name: Refunds
    expression: SUM(CASE WHEN line_item_line_item_type = 'Refund' THEN line_item_unblended_cost ELSE 0 END)
    description: Refunds applied
    format_preset: currency_usd

  # Aggregation metrics
  - name: line_items
    display_name: Line Items
    expression: COUNT(*)
    description: Number of line items
    format_preset: humanize

  - name: unique_services
    display_name: Unique Services
    expression: COUNT(DISTINCT line_item_product_code)
    description: Number of unique AWS services used
    format_preset: humanize

  - name: unique_accounts
    display_name: Unique Accounts
    expression: COUNT(DISTINCT line_item_usage_account_id)
    description: Number of accounts with charges
    format_preset: humanize

  - name: unique_regions
    display_name: Unique Regions
    expression: COUNT(DISTINCT product_region_code)
    description: Number of regions with usage
    format_preset: humanize

  # Cost efficiency metrics
  - name: avg_cost_per_hour
    display_name: Avg Cost/Hour
    expression: SUM(line_item_unblended_cost) / NULLIF(SUM(CASE WHEN line_item_usage_type LIKE '%BoxUsage%' OR line_item_usage_type LIKE '%Hours%' THEN line_item_usage_amount ELSE 0 END), 0)
    description: Average cost per compute hour
    format_preset: currency_usd
